name: Windows 11 RDP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
    - name: Download Ngrok
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath .\ngrok
        Write-Host "ngrok files:"
        Get-ChildItem .\ngrok

    - name: Setup Ngrok Auth Token
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        if (-not $Env:NGROK_AUTH_TOKEN) {
          Write-Error "Ù„Ø§ ÙŠÙˆØ¬Ø¯ NGROK_AUTH_TOKEN ÙÙŠ Secrets. Ø£Ø¶Ù Ø§Ù„Ù…ÙØªØ§Ø­ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„."
          exit 1
        }
        .\ngrok\ngrok.exe config add-authtoken $Env:NGROK_AUTH_TOKEN
        Write-Host "Ngrok authtoken saved."

    - name: Enable RDP Access
      run: |
        Write-Host "ØªÙ…ÙƒÙŠÙ† Remote Desktop ÙˆÙØªØ­ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ©..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        Write-Host "RDP enabled."

    - name: Create User (meets password policy & avoids interactive prompt)
      env:
        ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      run: |
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        $user = "tempAdmin"
        $pass = $Env:ADMIN_PASSWORD

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø³Ø±
        if (-not $pass) {
          Write-Error "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ SECRET Ø¨Ø§Ø³Ù… ADMIN_PASSWORD. Ø£Ø¶ÙÙ‡ ÙÙŠ Settings -> Secrets Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©."
          exit 1
        }

        # ÙØ­ÙˆØµØ§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (min 8, complexity, max 14 to avoid interactive prompt)
        if ($pass.Length -lt 8) {
          Write-Error "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."
          exit 1
        }
        if ($pass.Length -gt 14) {
          Write-Error "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ø·ÙˆÙ„ Ù…Ù† 14 Ø­Ø±ÙØ§Ù‹. Ù‚Ù„Ù‘Ù„ Ø§Ù„Ø·ÙˆÙ„ Ø¥Ù„Ù‰ 14 Ø£Ùˆ Ø£Ù‚Ù„ Ù„ØªØ¬Ù†Ø¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©."
          exit 1
        }
        if (-not ($pass -match '[A-Z]')) {
          Write-Error "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±Ù ÙƒØ¨ÙŠØ± (A-Z)."
          exit 1
        }
        if (-not ($pass -match '[a-z]')) {
          Write-Error "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±Ù ØµØºÙŠØ± (a-z)."
          exit 1
        }
        if (-not ($pass -match '\d')) {
          Write-Error "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù‚Ù…."
          exit 1
        }
        if (-not ($pass -match '[^A-Za-z0-9]')) {
          Write-Error "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø®Ø§Øµ (Ù…Ø«Ù„ ! @ # $ % ^ & * )."
          exit 1
        }

        Write-Host "Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… $user ..."
        # Ù†Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³ Ø­ÙˆÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„ØªÙØ§Ø¯ÙŠ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø®Ø§ØµØ©
        net user $user "$pass" /add /y

        if ($LASTEXITCODE -ne 0) {
          Write-Error "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª."
          exit $LASTEXITCODE
        }

        Write-Host "Ø¥Ø¶Ø§ÙØ© $user Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Administrators ..."
        net localgroup administrators $user /add

        if ($LASTEXITCODE -ne 0) {
          Write-Error "ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Administrators."
          exit $LASTEXITCODE
        }

        Write-Host "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­."
        net user $user

    - name: Install Google Chrome
      run: |
        Write-Host "Downloading Chrome..."
        Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile "$env:TEMP\chrome_installer.exe"
        Write-Host "Installing Chrome..."
        Start-Process -FilePath "$env:TEMP\chrome_installer.exe" -Args "/silent /install" -Wait
        Write-Host "Chrome installed successfully!"

    - name: Install Firefox
      run: |
        Write-Host "Downloading Firefox..."
        Invoke-WebRequest -Uri "https://download.mozilla.org/?product=firefox-latest&os=win64&lang=en-US" -OutFile "$env:TEMP\firefox_installer.exe"
        Write-Host "Installing Firefox..."
        Start-Process -FilePath "$env:TEMP\firefox_installer.exe" -Args "/S" -Wait
        Write-Host "Firefox installed successfully!"

    - name: Start Ngrok Tunnel (background)
      run: |
        $ngrokPath = ".\ngrok\ngrok.exe"
        if (-not (Test-Path $ngrokPath)) {
          Write-Error "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ngrok ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø±: $ngrokPath"
          exit 1
        }
        Write-Host "Starting ngrok in background (tcp 3389)..."
        # Ù†Ø³ØªØ®Ø¯Ù… WindowStyle Ùˆ PassThruØŒ ÙˆÙ„Ø§ Ù†Ø³ØªØ®Ø¯Ù… NoNewWindow
        $p = Start-Process -FilePath $ngrokPath -ArgumentList "tcp 3389" -WindowStyle Hidden -PassThru

        Start-Sleep -Seconds 3

        Write-Host "Ngrok started with PID: $($p.Id)"
        Write-Host "Ø¥Ù† Ù„Ù… ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§ØŒ Ø³ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©."

    - name: Get Ngrok Tunnel Info
      run: |
        Write-Host "Waiting for ngrok to initialize..."
        Start-Sleep -Seconds 5

        try {
          $response = Invoke-WebRequest -Uri "http://127.0.0.1:4040/api/tunnels" -UseBasicParsing -ErrorAction Stop
        } catch {
          Write-Error "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ÙˆØ§Ø¬Ù‡Ø© ngrok Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¹Ù„Ù‰ 127.0.0.1:4040. Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† inspector Ù…ÙØ¹Ù„Ù‹Ø§ Ø£Ùˆ ngrok Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯."
          exit 1
        }

        $json = $response.Content | ConvertFrom-Json

        if (-not $json.tunnels -or $json.tunnels.Count -eq 0) {
          Write-Error "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†ÙÙ‚ ngrok. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù†ÙÙ‚ ÙŠØ¹Ù…Ù„."
          exit 1
        }

        Write-Host "=== ngrok tunnels ==="
        foreach ($tunnel in $json.tunnels) {
          Write-Host "proto: $($tunnel.proto) | name: $($tunnel.name) | url: $($tunnel.public_url)"
        }

        # Ø·Ø¨Ø§Ø¹Ø© Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ TCP Ø¨ØµÙŠØºØ© Ù…Ø¨Ø³Ø·Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ Remote Desktop
        $tcp = $json.tunnels | Where-Object { $_.proto -eq "tcp" } | Select-Object -First 1
        if ($tcp) {
          # public_url Ø¹Ø§Ø¯Ø© ØªÙƒÙˆÙ† tcp://0.tcp.ngrok.io:xxxxx
          $public = $tcp.public_url
          Write-Host "==========================="
          Write-Host "ğŸ”— RDP Ø§ØªØµØ§Ù„ Ø¹Ø¨Ø± ngrok (public_url):"
          Write-Host $public
          Write-Host "Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…Ø¹ Remote Desktop. Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: tempAdmin Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: SECRET ADMIN_PASSWORD"
          Write-Host "Ù…Ø«Ø§Ù„: host = 0.tcp.ngrok.io   port = 12345"
          Write-Host "==========================="
        } else {
          Write-Host "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ÙÙ‚ TCP. Ù‚Ø¯ ÙŠÙƒÙˆÙ† ngrok Ø£Ù†Ø´Ø£ HTTP ÙÙ‚Ø·."
        }

    - name: Complete job
      run: |
        Write-Host "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù€ workflow. ØªØ°ÙƒÙ‘Ø± Ø£Ù† Ø§Ù„Ù€ GitHub Actions runner Ù…Ø¤Ù‚Øª (ephemeral) ÙˆØ³ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©."
