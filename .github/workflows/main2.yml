name: Temporary SSH Tunnel via ngrok (Password Auth)

on:
  workflow_dispatch: # يسمح بتشغيل المهمة يدويًا
    inputs:
      ssh_password:
        description: 'كلمة المرور التي تريد استخدامها للاتصال عبر SSH (ستظهر في السجلات!)'
        required: true
        default: 'MySecurePassword123'

jobs:
  ssh_tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # الحد الأقصى للتشغيل هو 6 ساعات

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH Access with Password
      env:
        SSH_PASSWORD: ${{ github.event.inputs.ssh_password }}
      run: |
        # 1. تثبيت OpenSSH Server
        sudo apt update
        sudo apt install openssh-server -y
        
        # 2. تعيين كلمة المرور للمستخدم 'runner'
        echo "runner:$SSH_PASSWORD" | sudo chpasswd
        
        # 3. تعديل إعدادات SSH للسماح بالدخول بكلمة مرور
        sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/g' /etc/ssh/sshd_config
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/g' /etc/ssh/sshd_config
        
        # 4. إعادة تشغيل خدمة SSH
        sudo service ssh restart
        
        echo "SSH setup complete. User 'runner' can connect with the provided password."

    - name: Install ngrok
      run: |
        # تثبيت ngrok على العدّاد المستضاف من GitHub (Ubuntu)
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install ngrok -y

    - name: Connect ngrok and Get Public URL
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }} # استخدام الرمز السري
      run: |
        # تفعيل الرمز المميز وبدء النفق على المنفذ 22 (SSH)
        ngrok authtoken $NGROK_AUTH_TOKEN
        ngrok tcp 22 --log=stdout > ngrok.log &
        sleep 10 # إعطاء وقت لـ ngrok للاتصال

        # الحصول على رابط ngrok العام من واجهة برمجة التطبيقات المحلية
        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"[^"]*' | grep -o '[^"]*$')
        
        echo "::notice file=ngrok_url.txt::The temporary public SSH address is: $NGROK_URL"
        echo "------------------------------------------------"
        echo "عنوان SSH العام المؤقت هو: $NGROK_URL"
        echo "اسم المستخدم: runner"
        echo "كلمة المرور: ${{ github.event.inputs.ssh_password }}"
        echo "------------------------------------------------"

    - name: Keep Job Alive (Maximum 6 Hours)
      run: |
        echo "الخادم المؤقت يعمل الآن. المهمة ستستمر لمدة 6 ساعات كحد أقصى."
        echo "لإنهاء الخادم، قم بإلغاء سير العمل يدويًا من واجهة GitHub Actions."
        sleep 21600 # 6 ساعات * 60 دقيقة * 60 ثانية = 21600 ثانية
